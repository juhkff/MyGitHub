Easy_message是大一下学期我们组做的（第一个）课设，我是负责后台部分的。<br>
怎么说呢，单从内容上独立来说的话，作为大一刚读了半学期的我来说代码的水平应该还算可以的，但是。。最致命的问题就是我们（两人）缺乏做项目的经验，导致了严重的沟通问题，最后也没能交出一个满意的结果。。<br>
前台用的是java新出的冷门fx，我的后台（当然也是java）是tomcat/servlet+JDBC数据库+udpsocket/tcpsocket。课设是做一个miniQQ，实现局域网通信即可，但我们想尝试做一个像QQ那样不仅限于（无用的）局域网聊天的程序。包括前台用fx以及我试图用udp实现p2p穿透，都是我们未曾接触甚至闻所未闻的东西，但是因为得知它们能较好地完成我们的期望，所以我们都花了大工夫研究这方面（当然还有其它很多方面）的内容。（数周沉迷编程直接导致我其它科目成绩爆炸(╯°口°)╯(┴—┴ 一把辛酸泪啊)。<br>
扯远了。因为这是我们第一个项目（课设），而且是在大一没怎么学真东西的情况下做的，所以质量自然不算好。不过code过程中遇到的问题还是值得一说的。<br>
****
前面也说了，我本来是打算像“传闻”那样用udp实现p2p穿透（对于当时的我真是天书般的词语）的，但是研究了很长时间后我不得不放弃这个想法，因为我发现完美地实现用udp打洞，至少对于目前的我来说是不可能做到的。这也是随着不断地搜寻资料和亲自测试慢慢得出来的结论。<br>
一开始我根据搜到的资料，以为只要用udpsocket吧udppacket发给服务器（没错我们还自己租了个10块/月那种的廉价服务器），服务器解析出包的地址存起来就可以了，但是在实践中总是频频出现问题。而且这种问题不是那种一味的出错，而是更让人DT（和谐）的有时候正常有时候出错——具体来说就是有时候发送的消息对面能收到有时对面却收不到。这个问题让我一脸懵逼，因为我完全不知道这是犯的哪门子邪。后来在不断的反复翻看相关资料和博客等资源（学习的时间正在疯狂流逝qwq）以后我总算才渐渐意识到这和网络环境也有关系。目前我也不太懂相关的具体知识，反正大概就是局域网和公网之间有一个NAT机 会转换你都IP地址，而你映射到外网/公网的IP的“可用程度”是和你当前网络的NAT类型有关的。那说道类型的话，NAT分为3种（查了查发现其实是4种= =）类型：全锥型、受限锥形、端口受限锥形（这俩感觉差不多）、对称型。而最后一个——对称型则是p2p穿透的噩梦。至于为什么我有时候程序正常有时候没用，就是因为网络环境不同。成功的时候，我的电脑都是接的校园的网线的，而失败的时候我都是接的无线网或用手机数据流量开的热点。为啥会有这种区别呢？我也很好奇，就想找找有没有检测NAT类型的软件。本来觉得找不到，结果居然真的有。下下来一检测，连网线时检测的是Full Cone全锥型，而连无线网时则是受限锥形（具体哪种忘了），而用数据流量的热点时是，对、称、型。对称型NAT下是不可能、至少是极难实现p2p穿透的。所以这迫使我打消了利用p2p穿透实现聊天的构想，转而求其次，也就是客户端传给服务器，由服务器负责转发消息。当然，服务器的负担无疑是加重了许多，但这也没办法的了。<br>
至于为什么对称型NAT不能实现p2p穿透，我倒是有非常直观的感受。首先要知道发送聊天信息需要知道对方的IP和端口，才能把udp定向并发送过去。于是我写了一个每隔一段时间能够获取自己当前的公网ip地址的小程序（不在这个项目里），检测的结果是：全锥型情况下，也就是连网线的情况下，映射到外网的ip和端口是永远绝对不会变的，所以udpsocket的定位是绝对准确的，在不丢包（丢包：udp的劣势之一，udp是不能保证准确性和结果的发送协议，换句话就是说它只负责收到你指定的目标，然后给它发过去，至于对方收没收到它就不管了，但一般的小程序里这种情况发生的概率是很低的。——毕竟你想，你玩FPS、玩CS、CSGO这种比起小程序来说大得多的游戏时，只要网不差，也不经常发生丢包现象不是么(｡･ω･｡)）的情况下对方是绝对能接收到消息的；而电脑连无线网、也就是NAT是受限锥形的时候，从程序可以看出，本机映射到外网的IP和端口在第一个udppacket包发送后的120s内（很精确的数字）是不会变化的，但是如果在120s内没有下一个udp包发送过来的话，端口就会发生变化（ip会不会变我记不清了，反正端口一定会变）。（以下为我的猜测）也就是说这一个已经建立的连接就会超时并断掉，而120s后的第一个udp包又会引发一个新的连接，这种情况下可以写个心跳线程保证通讯，虽然麻烦一点但还是可以做到的。而最恐怖的就是这个对称型NAT了。这个NAT下，从程序中可以看出，无论你前后两个udp包发的有多么迅速，无论你怎么办，它的每个udp包的地址都、不、一、样！也就是说你是不可能、impossible to指定某个消息发送给某个用户的，因为这个用户没有固定的可信的ip 给你作为发/给他作为收 消息  的地址！至于网上有人说或许能通过推测端口号的方法实现穿透（唔，这么看来ip是不会变的，变的是端口号）。照我理解这是因为通过我写的测试程序可以看出，每个udp包使用的端口号其实都是紧挨着的——比如上一个udp包用的25565的端口，那么下一个udp包理论上应该用的就是25566的端口。在udp包快速发送的情况下也确实是如此。但是问题在于你绝对不能做到在两个udp收发的间隙没有其它电脑的程序占用这下一个端口。所以理论上或许可以实现穿透，但至少也是极难的——至少我是写不出来的。<br>
综上，我抛弃了p2p穿透的想法，只能用服务器转发了。所以之前写的p2p全都成了P勒(╯°口°)╯(┴—┴学习的时间还在流逝ing啊啊..<br>
不知道为什么学校的网线这么的神奇（￣▽￣）大概是ipv6的奇迹？<br>
嘛，所以到底有没有以p2p为原理的能稳定运行程序勒(〜￣△￣)〜它又是怎么解决的勒(〜￣△￣)〜<br>
此外当然还有各种大大小小的问题(´；ω；\`)我们忙活到最后一刻也没做好，最后到了现场刚刚交互好的那部分又改出了莫名bug（反正我真的不记得我有删过什么东西啊啊啊）。还好最后靠着另一位同学的界面和说辞竟然奇迹般的拿了A+（但是我们几乎没跟你展示成果啊老师，你咋想的勒╮(￣▽￣)╭）唔，这么看我好咸鱼啊(>\_>)<br>
反正这个项目写到最后也还有各种毛病，现在也没改（因为它跟前台的结合实在太差了我实在没动力改= =前后端结合——这也是我们这次得到的最大的教训吧）。所以代码很多bug，有不通的地方很正常（有个功能我都还没实现呢（￣へ￣））push上来纯粹是给自己当个经验罢了~。<br>
